{% extends "base.html" %}
{% block content %}
<article class="post-detail">
    <h1>{{ post.title }}</h1>
    <p class="meta">ä½œè€…ï¼š{{ post.author_name }} Â· åˆ†ç±»ï¼š{{ post.tags or 'æœªåˆ†ç±»' }} Â· å‘å¸ƒæ—¶é—´ï¼š{{ post.created_at }}</p>
    <div class="body">{{ post.body | replace('\n', '<br>') | safe }}</div>
</article>
<section class="reactions">
    <h2>äº’åŠ¨</h2>
    <div class="reaction-summary">
        <span>ğŸ‘ å–œæ¬¢ï¼š<strong id="like-count">{{ post.like_count }}</strong></span>
        <span>â­ æ”¶è—ï¼š<strong id="favorite-count">{{ post.favorite_count }}</strong></span>
    </div>
    {% if user %}
    <div class="reaction-actions">
        <button type="button" class="reaction-btn {% if post.liked %}active{% endif %}" data-type="like">
            ğŸ‘ å–œæ¬¢
        </button>
        <button type="button" class="reaction-btn {% if post.favorited %}active{% endif %}" data-type="favorite">
            â­ æ”¶è—
        </button>
    </div>
    <div id="reaction-message" class="form-message"></div>
    {% else %}
    <p class="hint">ç™»å½•åå¯ä»¥ç‚¹èµæˆ–æ”¶è—è¿™ç¯‡æ–‡ç« ã€‚</p>
    {% endif %}
</section>
<section class="comments">
    <h2>è¯„è®º</h2>
    {% if comments %}
        <ul>
            {% for item in comments %}
            <li>
                <div class="comment-author">{{ item.author_name }} Â· {{ item.created_at }}</div>
                <p>{{ item.body }}</p>
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>æš‚æ— è¯„è®ºã€‚</p>
    {% endif %}
    {% if user %}
    <form id="comment-form">
        <textarea name="body" rows="3" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•" required></textarea>
        <button type="submit">æäº¤è¯„è®º</button>
    </form>
    <div id="comment-message" class="form-message"></div>
    {% else %}
    <p>è¯·å…ˆ <a href="/login">ç™»å½•</a> åè¯„è®ºã€‚</p>
    {% endif %}
</section>
<script>
const commentForm = document.getElementById('comment-form');
if (commentForm) {
    const commentMsg = document.getElementById('comment-message');
    commentForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        commentMsg.textContent = 'æ­£åœ¨æäº¤...';
        const payload = { body: commentForm.body.value };
        const resp = await fetch('/api/posts/{{ post.id }}/comments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (resp.ok) {
            commentMsg.textContent = 'è¯„è®ºæˆåŠŸï¼Œåˆ·æ–°ä¸­...';
            setTimeout(() => window.location.reload(), 500);
        } else {
            commentMsg.textContent = data.error || 'è¯„è®ºå¤±è´¥';
        }
    });
}

const reactionButtons = document.querySelectorAll('.reaction-btn');
if (reactionButtons.length) {
    let liked = {{ 'true' if post.liked else 'false' }};
    let favorited = {{ 'true' if post.favorited else 'false' }};
    const msg = document.getElementById('reaction-message');
    const updateState = (type, active) => {
        reactionButtons.forEach(btn => {
            if (btn.dataset.type === type) {
                btn.classList.toggle('active', active);
            }
        });
    };
    reactionButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
            const type = btn.dataset.type;
            btn.disabled = true;
            msg.textContent = 'åŒæ­¥ä¸­...';
            try {
                const resp = await fetch('/api/posts/{{ post.id }}/reaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reaction: type })
                });
                const data = await resp.json();
                if (!resp.ok) {
                    msg.textContent = data.error || 'æ“ä½œå¤±è´¥';
                } else {
                    document.getElementById('like-count').textContent = data.stats.like;
                    document.getElementById('favorite-count').textContent = data.stats.favorite;
                    if (type === 'like') {
                        liked = !liked;
                        updateState('like', liked);
                    } else {
                        favorited = !favorited;
                        updateState('favorite', favorited);
                    }
                    msg.textContent = 'å·²æ›´æ–°';
                }
            } catch (error) {
                msg.textContent = 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•';
            } finally {
                btn.disabled = false;
            }
        });
    });
}
</script>
{% endblock %}
